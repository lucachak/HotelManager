<div id="room-modal" class="fixed inset-0 z-50 flex items-center justify-center p-4">

    <div class="absolute inset-0 bg-black/60 backdrop-blur-sm transition-opacity"
         onclick="document.getElementById('room-modal').remove()"></div>

    <div id="modal-content-card" class="bg-base-100 rounded-2xl shadow-2xl w-full max-w-lg relative z-10 overflow-hidden flex flex-col max-h-[90vh] animate-fade-in">

        <button onclick="document.getElementById('room-modal').remove()"
                class="btn btn-sm btn-circle btn-ghost absolute right-3 top-3 z-50 hover:bg-gray-100">✕</button>

        <div class="p-6 pb-2">
            <div class="flex items-center gap-4">
                <div class="w-16 h-16 rounded-2xl flex items-center justify-center text-2xl font-bold shadow-sm border border-gray-100
                    {% if allocation %}bg-rose-50 text-rose-600
                    {% elif room.status == 'DIRTY' %}bg-amber-50 text-amber-600
                    {% else %}bg-emerald-50 text-emerald-600{% endif %}">
                    {{ room.number }}
                </div>

                <div>
                    <h3 class="font-bold text-xl text-gray-800">{{ room.category.name }}</h3>
                    <div class="flex items-center gap-2 mt-1">
                        {% if allocation %}
                            <span class="badge badge-error gap-1 text-white font-bold animate-pulse">
                                <i data-lucide="user" class="w-3 h-3"></i> Ocupado
                            </span>
                        {% elif room.status == 'DIRTY' %}
                            <span class="badge badge-warning gap-1 text-white font-bold">
                                <i data-lucide="sparkles" class="w-3 h-3"></i> Limpeza
                            </span>
                        {% else %}
                            <span class="badge badge-success gap-1 text-white font-bold">
                                <i data-lucide="check" class="w-3 h-3"></i> Disponível
                            </span>
                        {% endif %}
                        <span class="text-xs text-gray-400">• {{ room.floor }}º Andar</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="p-6 pt-2 overflow-y-auto flex-1">

            {% if allocation %}
                <div class="bg-gray-50 rounded-xl p-4 border border-gray-100 mb-4">
                    <div class="flex justify-between items-start mb-2">
                        <div>
                            <h4 class="font-bold text-gray-800">{{ allocation.booking.guest.name }}</h4>
                            <p class="text-xs text-gray-500">Reserva #{{ allocation.booking.id|slice:":8" }}</p>
                        </div>
                        <a href="{% url 'booking_fnrh_pdf' allocation.booking.id %}" target="_blank" class="btn btn-xs btn-ghost gap-1" title="Imprimir Ficha">
                            <i data-lucide="printer" class="w-3 h-3"></i> FNRH
                        </a>
                    </div>

                    <div class="flex gap-4 text-sm mt-3">
                        <div>
                            <span class="block text-xs text-gray-400 font-bold uppercase">Entrada</span>
                            <span class="font-mono text-gray-700">{{ allocation.start_date|date:"d/m" }}</span>
                        </div>
                        <div>
                            <span class="block text-xs text-gray-400 font-bold uppercase">Saída</span>
                            <span class="font-mono text-gray-700">{{ allocation.end_date|date:"d/m" }}</span>
                        </div>
                        <div class="ml-auto text-right">
                            <span class="block text-xs text-gray-400 font-bold uppercase">Saldo Devedor</span>
                            <span class="font-mono font-bold {% if allocation.booking.balance_due > 0 %}text-rose-600{% else %}text-emerald-600{% endif %}">
                                R$ {{ allocation.booking.balance_due }}
                            </span>
                        </div>
                    </div>
                </div>

                {% if allocation.booking.total_value > 0 %}
                <div class="mb-4">
                    <h5 class="text-xs font-bold text-gray-400 uppercase mb-2 flex items-center gap-1">
                        <i data-lucide="receipt" class="w-3 h-3"></i> Extrato Rápido
                    </h5>
                    <div class="space-y-1 text-sm bg-white border rounded p-2 max-h-32 overflow-y-auto">
                        {% for item in allocation.booking.payments.all %}
                            <div class="flex justify-between border-b border-gray-50 last:border-0 pb-1">
                                <span class="text-gray-600 text-xs">{{ item.description }}</span>
                                <span class="font-mono text-xs font-bold {% if item.transaction_type == 'INCOME' %}text-emerald-600{% else %}text-rose-600{% endif %}">
                                    {% if item.transaction_type == 'INCOME' %}-{% endif %}R$ {{ item.amount }}
                                </span>
                            </div>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}

                <div class="space-y-3 pt-2 border-t border-gray-100">

                    {% if allocation.booking.status == 'CONFIRMED' %}
                        <div class="alert alert-info text-xs shadow-sm py-2">
                            <i data-lucide="info" class="w-4 h-4"></i> Reserva confirmada. Aguardando entrada.
                        </div>
                        <button
                            hx-post="{% url 'checkin_htmx' allocation.booking.id %}"
                            hx-confirm="Confirmar a entrada do hóspede?"
                            class="btn btn-primary w-full text-white shadow-lg shadow-blue-500/30">
                            <i data-lucide="user-check" class="w-4 h-4"></i> Realizar Check-in
                        </button>

                    {% elif allocation.booking.status == 'CHECKED_IN' %}
                        <div class="grid grid-cols-2 gap-2">
                            <button
                                hx-get="{% url 'receive_payment_htmx' allocation.booking.id %}"
                                hx-target="#booking-modal-container"
                                hx-swap="innerHTML"
                                class="btn btn-success text-white shadow-sm">
                                <i data-lucide="banknote" class="w-4 h-4"></i> Receber
                            </button>

                            <button
                                hx-get="{% url 'add_consumption_htmx' allocation.booking.id %}"
                                hx-target="#booking-modal-container"
                                hx-swap="innerHTML"
                                class="btn btn-warning text-white shadow-sm">
                                <i data-lucide="wine" class="w-4 h-4"></i> Consumo
                            </button>
                        </div>

                        <button
                            hx-post="{% url 'checkout_htmx' allocation.booking.id %}"
                            hx-confirm="Deseja finalizar a estadia e liberar o quarto para limpeza?"
                            class="btn btn-outline btn-error w-full mt-2">
                            <i data-lucide="log-out" class="w-4 h-4"></i> Finalizar Estadia (Check-out)
                        </button>
                    {% endif %}
                </div>

            {% elif room.status == 'DIRTY' %}
                <div class="text-center py-8 space-y-4">
                    <div class="p-4 bg-amber-50 text-amber-600 rounded-full inline-block border-4 border-amber-100/50 animate-bounce">
                        <i data-lucide="sparkles" class="w-10 h-10"></i>
                    </div>
                    <div>
                        <h4 class="font-bold text-gray-800 text-lg">Aguardando Limpeza</h4>
                        <p class="text-sm text-gray-500 px-8">O hóspede saiu. O quarto precisa ser higienizado antes de liberar.</p>
                    </div>
                </div>

                <div class="mt-6 pt-4 border-t border-gray-100">
                    <form hx-post="{% url 'clean_room_action' room.id %}">
                        <button type="submit" class="btn btn-warning text-white w-full shadow-lg shadow-amber-200 gap-2">
                            <i data-lucide="check-circle-2" class="w-5 h-5"></i>
                            Confirmar Limpeza Concluída
                        </button>
                    </form>
                </div>

            {% else %}
                <div class="text-center py-8 space-y-4">
                    <div class="p-4 bg-emerald-50 text-emerald-600 rounded-full inline-block border-4 border-emerald-100/50">
                        <i data-lucide="bed-double" class="w-10 h-10"></i>
                    </div>
                    <div>
                        <h4 class="font-bold text-gray-800 text-lg">Quarto Livre</h4>
                        <p class="text-sm text-gray-500">Pronto para receber hóspedes.</p>
                    </div>
                </div>

                <div class="mt-6 pt-4 border-t border-gray-100">
                    <button
                        hx-get="{% url 'create_booking_htmx' %}?room={{ room.id }}"
                        hx-target="#modal-content-card"
                        hx-swap="outerHTML transition:true"
                        class="btn btn-primary w-full shadow-lg shadow-primary/20 text-white gap-2">
                        <i data-lucide="calendar-plus" class="w-4 h-4"></i> Criar Nova Reserva
                    </button>
                </div>
            {% endif %}
        </div>
    </div>
</div>

<script>
    if (typeof lucide !== 'undefined') lucide.createIcons();
</script>
