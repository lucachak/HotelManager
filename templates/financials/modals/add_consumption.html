<div
    id="room-modal"
    class="fixed inset-0 z-[60] flex items-center justify-center p-4"
>
    <div
        class="absolute inset-0 bg-black/60 backdrop-blur-sm transition-opacity"
        onclick="document.getElementById('room-modal').remove()"
    ></div>

    <div
        class="bg-base-100 rounded-2xl shadow-2xl w-full max-w-sm relative z-10 overflow-hidden animate-fade-in flex flex-col"
    >
        <div
            class="bg-amber-500 p-4 text-white flex justify-between items-center shadow-md"
        >
            <div class="flex items-center gap-3">
                <div class="bg-white/20 p-2 rounded-lg">
                    <i data-lucide="wine" class="w-6 h-6 text-white"></i>
                </div>
                <div>
                    <h3 class="font-bold text-lg leading-tight">
                        Lançar Consumo
                    </h3>
                    <p class="text-xs text-amber-100 font-medium">
                        Quarto {{ booking.allocations.first.room.number }} • {{
                        booking.guest.name|truncatechars:15 }}
                    </p>
                </div>
            </div>
            <button
                onclick="document.getElementById('room-modal').remove()"
                class="btn btn-ghost btn-circle btn-sm text-white hover:bg-white/20"
            >
                ✕
            </button>
        </div>

        <form
            hx-post="{% url 'add_consumption_htmx' booking.id %}"
            hx-target="#booking-modal-container"
            hx-swap="innerHTML"
            class="flex flex-col flex-1"
        >
            <div class="p-6 space-y-5">
                {% if error %}
                <div
                    class="alert alert-error text-white text-sm shadow-sm rounded-xl"
                >
                    <i data-lucide="alert-circle" class="w-5 h-5"></i>
                    <span>{{ error }}</span>
                </div>
                {% endif %}

                <div class="form-control">
                    <label
                        class="label font-bold text-gray-500 text-xs uppercase"
                        >Produto</label
                    >
                    {{ form.product }}
                    <label class="label">
                        <span class="label-text-alt text-gray-400"
                            >Exibe apenas itens com estoque.</span
                        >
                    </label>
                </div>

                <div class="flex gap-4">
                    <div class="form-control w-1/3">
                        <label
                            class="label font-bold text-gray-500 text-xs uppercase"
                            >Qtd.</label
                        >
                        {{ form.quantity }}
                    </div>

                    <div class="form-control w-2/3">
                        <label
                            class="label font-bold text-gray-500 text-xs uppercase text-right w-full"
                            >Total Estimado</label
                        >
                        <div
                            class="input input-bordered bg-gray-50 border-gray-200 flex items-center justify-end font-mono text-xl font-bold text-amber-600"
                        >
                            R$ <span id="total-display" class="ml-2">0,00</span>
                        </div>
                    </div>
                </div>
            </div>

            <div
                class="p-4 bg-gray-50 border-t border-gray-100 flex justify-end gap-3"
            >
                {% with room=booking.allocations.first.room %}
                <button
                    type="button"
                    hx-get="{% url 'room_details_modal' room.id %}"
                    hx-target="#booking-modal-container"
                    hx-swap="innerHTML"
                    class="btn btn-ghost text-gray-500"
                >
                    Voltar
                </button>
                {% endwith %}

                <button
                    type="submit"
                    class="btn btn-warning text-white shadow-lg shadow-amber-500/30 gap-2"
                >
                    <i data-lucide="plus-circle" class="w-4 h-4"></i> Adicionar
                </button>
            </div>
        </form>
    </div>
</div>

<script>
    lucide.createIcons();

    // Lógica simples para extrair o preço do texto do dropdown e calcular o total
    // Formato esperado do texto: "Nome do Produto | R$ 10.50 (Est: 5)"
    function updateTotal() {
        const select = document.querySelector('select[name="product"]');
        const qtyInput = document.querySelector('input[name="quantity"]');
        const totalDisplay = document.getElementById("total-display");

        if (select && select.selectedIndex > 0) {
            // Se algum item foi selecionado
            const text = select.options[select.selectedIndex].text;

            // Regex para pegar o preço entre "R$" e "("
            // Procura por "R$" seguido de espaco e digitos/pontos/virgulas
            const match = text.match(/R\$\s*([\d,.]+)/);

            if (match) {
                // Converte "10,50" ou "10.50" para float JS
                let priceStr = match[1].replace(",", ".");
                let price = parseFloat(priceStr);
                let qty = parseInt(qtyInput.value) || 0;

                if (!isNaN(price)) {
                    let total = price * qty;
                    totalDisplay.innerText = total.toFixed(2).replace(".", ",");
                    return;
                }
            }
        }

        // Se nada selecionado ou erro
        totalDisplay.innerText = "0,00";
    }

    // Roda ao abrir para garantir (caso navegador preencha automático)
    setTimeout(updateTotal, 100);
</script>
